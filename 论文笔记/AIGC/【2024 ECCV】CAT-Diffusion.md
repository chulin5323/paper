# Improving Text-guided Object Inpainting with Semantic Pre-inpainting

[PDF](..\..\AIGC\inpainting\【2024 ECCV】Improving Text-guided Object Inpainting with semantic Pre-inpainting.pdf) [arxiv](https://arxiv.org/pdf/2409.08260) [code](https://github.com/Nnn-s/CATdiffusion) 

> 这篇文章介绍了一种名为CAT-Diffusion的新框架，用于改善文本引导的对象修复技术。该框架通过将**单阶段对象修复**分解为**两个级联过程**来增强图像的编辑性：首先是**语义预修复**，即在多模态特征空间中推断目标对象的语义特征；其次是在**扩散潜在空间中进行高保真度的对象生成**。文章使用基于Transformer的语义修复器（semantic pre-inpainting）和对象修复扩散模型（high-fieldity object generation），实现了对文本提示描述的区域内新对象的高质量生成。实验结果表明，CAT-Diffusion在OpenImages-V6和MSCOCO数据集上的表现优于现有技术。

## 解决的问题

主要解决了文本引导的对象修复中的两个问题：

1. **文本与视觉对象对齐不足**：仅依赖单一U-Net在所有去噪时间步中对齐文本提示和视觉对象，难以生成期望的对象。

2. **对象生成的可控性不强**：在扩散模型复杂的采样空间中，没有额外控制信号的情况下，精确控制视觉对象的生成是一个挑战。

## 相关研究及缺陷

<img src="D:\learning\paper\论文笔记\AIGC\fig\CAT-diffusion_1.png" style="zoom:80%;" />

1. **传统图像修复方法**：
   - **缺陷**：这些方法主要关注于恢复图像的损坏区域，而没有利用额外的条件信息，如文本提示，因此无法根据文本描述生成新的图像内容。

2. **基于文本提示的图像修复**：
   - **缺陷**：这些方法虽然利用了文本提示来完成图像的缺失部分，但可能无法保证生成的对象与文本提示在视觉和语义上的一致性。

3. **基于扩散模型的文本到图像合成**：
   - **缺陷**：这些模型虽然能够根据文本提示生成高质量的图像，但在文本引导的对象修复任务中，直接将这些模型应用于修复可能会导致新对象与背景之间的不协调，以及在去噪过程中文本提示与图像内容的对齐问题。

4. **SmartBrush**：
   - **缺陷**：尽管SmartBrush利用对象标签作为提示，二进制掩码作为形状指导来引导扩散模型进行对象修复，但其仍然存在由于仅依赖单一U-Net而导致的对齐问题，以及在复杂采样空间中精确控制对象生成的挑战。

5. **其他扩散模型**：
   - **缺陷**：这些模型在进行文本引导的对象修复时，可能无法充分考虑新对象与背景之间的内在关系，导致在修复区域周围出现明显的伪影和对象结构扭曲。

文章提出的CAT-Diffusion框架正是为了解决上述研究中的缺陷，通过引入语义预修复和级联的生成过程，增强了文本提示与视觉对象的对齐，并提高了对象生成的可控性。

## 方法

<img src="D:\learning\paper\论文笔记\AIGC\fig\CAT-diffusion_2.png" style="zoom:80%;" />

1. **级联过程（CAscaded Transformer-Diffusion, CAT-Diffusion）**：

   - 将传统的单阶段对象修复分解为两个级联过程：语义预修复和对象生成。

2. **语义预修复**：

   > 特征级别的对齐。

   - 使用基于Transformer的语义修复器（Semantic Inpainter）在**多模态特征空间**（例如CLIP空间）中预测目标对象的语义特征。
   - 通过知识蒸馏（Knowledge Distillation）从教师模型（如CLIP）转移多模态知识到语义修复器，以预测与文本提示条件相符合的语义特征。

3. **参考适配器层（Reference Adapter Layer）**：

   - 在对象修复扩散模型中引入参考适配器层，该层作为一个多头交叉注意力层，用于调节视觉提示，增强扩散模型对对象修复的控制能力。

4. **对象修复扩散模型**：
   - 利用预修复的语义特征作为视觉提示，引导扩散模型生成与文本提示语义对齐且与背景视觉一致的高保真度对象。

5. **训练策略**：
   - **扩散损失（Diffusion Loss）**：用于训练配备参考适配器层的对象修复扩散模型。
   - **知识蒸馏损失（Knowledge Distillation Loss）**：用于监督语义修复器，使其预测的语义特征与文本提示对齐。
